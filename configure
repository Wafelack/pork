#!/usr/bin/env bash
set -euo pipefail
KERNEL=$(uname -a | awk '{print $1}')
PREFIX="/usr/"
PROGRAM="rad"
if [[ $KERNEL == "Darwin" ]]
then
	PREFIX="/usr/local/"
elif [[ $KERNEL != "Linux" ]]
then
	echo "Your kernel is unsupported. Please open an issue <https://github.com/Wafelack/rad/issues/new> to reclaim it."
	exit 1
fi

cat >> Makefile << EOF
CONF := /etc/${PROGRAM}.toml
FILES := \$(shell find src/ -name *.rs)
BINARY := target/release/${PROGRAM}
PREFIX ?= ${PREFIX}
MAN ?= \$(PREFIX)/share/man/

\$(BINARY) : \$(FILES)
	cargo build --release

install : \$(BINARY)
	chown root:root \$(BINARY)
	cp \$(BINARY) \$(PREFIX)/bin/
	chmod 4711 \$(PREFIX)/bin/${PROGRAM}
	touch \$(CONF)
	chown root:root \$(CONF)
	chmod 600 \$(CONF)
	cp ${PROGRAM}.1 \$(MAN)/man1/
	cp ${PROGRAM}.conf.5 \$(MAN)/man5/
	cp ${PROGRAM}.pam /etc/pam.d/${PROGRAM}
	@echo -e "${PROGRAM} has successfully been installed.\nPlease configure permissions in \$(CONF) (\\\`man 5 ${PROGRAM}.conf\\\` for instructions.)."

uninstall :
	rm \$(PREFIX)/bin/${PROGRAM}
	rm \$(MAN)/man1/${PROGRAM}.1
	rm \$(MAN)/man5/${PROGRAM}.conf.5
	rm /etc/pam.d/${PROGRAM}
EOF
